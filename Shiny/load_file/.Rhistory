server = server,
...
)
}
View(launchShiny)
data = readRDS('C:\\Users\\corey\\OneDrive\\Bureau\\data.RDS')
launchShiny()
View(data)
type = c('IC_1','IC_2','IC_3')
ic_types=data@reductions$ica@cell.embeddings[,type]
img<-grDevices::as.raster(data@images$slice1@image)
l=length(type)
if(l>1){
ic_types<-apply(ic_types,2,function(x){x=ifelse(x<=0,0,x); return(x)})
sum_IC<-apply(ic_types,2,function(x){x=x/sum(x); return(x)})
sum_IC=sqrt((rowSums(sum_IC)/max(rowSums(sum_IC))))
ic_types<-apply(ic_types,1,function(x){x/sum(x); return(x)})
ic_types<-cbind(data@images$slice1@coordinates,t(ic_types)) %>%  cbind(.,sum_IC) %>% as.tibble
grid=interp(ic_types$imagecol,ic_types$imagerow,ic_types$sum_IC)
griddf <- data.frame(x = rep(grid$x, ncol(grid$z)),
y = rep(grid$y, each = nrow(grid$z)),
z = as.numeric(grid$z))
griddf$z2=ifelse(griddf$z<quantile(griddf$z,na.rm = TRUE,probs = seq(0, 1, 1/10))[2],0,griddf$z)
# pie chart
p<-   ggplot( data = ic_types,aes(x = imagecol, y = imagerow)) +
annotation_raster(img,xmin = 0,xmax = Inf,ymin = 0,ymax = Inf) +
geom_scatterpie(data = ic_types,
aes(x = imagecol, y = (-imagerow),
r=sum_IC*200),
cols = paste0("IC_",type),
color=NA) +
coord_equal()+
theme_void()
#
p1<-   ggplot( data = ic_types,aes(x = imagecol, y = imagerow)) +
annotation_raster(img,xmin = 0,xmax = Inf,ymin = 0,ymax = Inf)+
geom_contour(data = griddf,aes(x = x, y = (-y) , z=z2),breaks = thresh)  +
geom_contour_filled(data = griddf,aes(x = x, y = (-y) , z=z2),alpha=thresh.alpha, breaks = c(thresh,1), fill="blue")+
coord_equal()+
theme_void()
p2<- ggplot(data = ic_types,aes(x = imagecol, y = imagerow))+
annotation_raster(img,xmin = 0,xmax = Inf,ymin = 0,ymax = Inf) +
geom_contour_filled(data = griddf,aes(x = x, y = (-y) , z=z)) +
coord_equal()+
theme_void()
p3<- ggplot(data = griddf,aes(x = x, y = (-y) , z=z2))+
annotation_raster(img,xmin = 0,xmax = Inf,ymin = 0,ymax = Inf) +
geom_contour(breaks = thresh) +
geom_contour_filled(alpha=thresh.alpha, breaks = c(thresh,1), fill="blue")+
coord_equal()+
theme_void()
}
ic_types<-apply(ic_types,2,function(x){x=ifelse(x<=0,0,x); return(x)})
sum_IC<-apply(ic_types,2,function(x){x=x/sum(x); return(x)})
sum_IC=sqrt((rowSums(sum_IC)/max(rowSums(sum_IC))))
ic_types<-apply(ic_types,1,function(x){x/sum(x); return(x)})
ic_types<-cbind(data@images$slice1@coordinates,t(ic_types)) %>%  cbind(.,sum_IC) %>% as.tibble
grid=interp(ic_types$imagecol,ic_types$imagerow,ic_types$sum_IC)
ic_types=data@reductions$ica@cell.embeddings[,type]
img<-grDevices::as.raster(data@images$slice1@image)
l=length(type)
ic_types<-apply(ic_types,2,function(x){x=ifelse(x<=0,0,x); return(x)})
sum_IC<-apply(ic_types,2,function(x){x=x/sum(x); return(x)})
sum_IC=sqrt((rowSums(sum_IC)/max(rowSums(sum_IC))))
ic_types<-apply(ic_types,1,function(x){x/sum(x); return(x)})
ic_types<-cbind(data@images$slice1@coordinates,t(ic_types)) %>%  cbind(.,sum_IC) %>% as.tibble
grid=interp(ic_types$imagecol,ic_types$imagerow,ic_types$sum_IC)
griddf <- data.frame(x = rep(grid$x, ncol(grid$z)),
y = rep(grid$y, each = nrow(grid$z)),
z = as.numeric(grid$z))
griddf$z2=ifelse(griddf$z<quantile(griddf$z,na.rm = TRUE,probs = seq(0, 1, 1/10))[2],0,griddf$z)
# pie chart
p<-   ggplot( data = ic_types,aes(x = imagecol, y = imagerow)) +
annotation_raster(img,xmin = 0,xmax = Inf,ymin = 0,ymax = Inf) +
geom_scatterpie(data = ic_types,
aes(x = imagecol, y = (-imagerow),
r=sum_IC*200),
cols = paste0("IC_",type),
color=NA) +
coord_equal()+
theme_void()
#
p1<-   ggplot( data = ic_types,aes(x = imagecol, y = imagerow)) +
annotation_raster(img,xmin = 0,xmax = Inf,ymin = 0,ymax = Inf)+
geom_contour(data = griddf,aes(x = x, y = (-y) , z=z2),breaks = thresh)  +
geom_contour_filled(data = griddf,aes(x = x, y = (-y) , z=z2),alpha=thresh.alpha, breaks = c(thresh,1), fill="blue")+
coord_equal()+
theme_void()
thresh=0.4
thresh.alpha=0.2
# pie chart
p<-   ggplot( data = ic_types,aes(x = imagecol, y = imagerow)) +
annotation_raster(img,xmin = 0,xmax = Inf,ymin = 0,ymax = Inf) +
geom_scatterpie(data = ic_types,
aes(x = imagecol, y = (-imagerow),
r=sum_IC*200),
cols = paste0("IC_",type),
color=NA) +
coord_equal()+
theme_void()
type
type = c(1,2,3)
# pie chart
p<-   ggplot( data = ic_types,aes(x = imagecol, y = imagerow)) +
annotation_raster(img,xmin = 0,xmax = Inf,ymin = 0,ymax = Inf) +
geom_scatterpie(data = ic_types,
aes(x = imagecol, y = (-imagerow),
r=sum_IC*200),
cols = paste0("IC_",type),
color=NA) +
coord_equal()+
theme_void()
#
p1<-   ggplot( data = ic_types,aes(x = imagecol, y = imagerow)) +
annotation_raster(img,xmin = 0,xmax = Inf,ymin = 0,ymax = Inf)+
geom_contour(data = griddf,aes(x = x, y = (-y) , z=z2),breaks = thresh)  +
geom_contour_filled(data = griddf,aes(x = x, y = (-y) , z=z2),alpha=thresh.alpha, breaks = c(thresh,1), fill="blue")+
coord_equal()+
theme_void()
p2<- ggplot(data = ic_types,aes(x = imagecol, y = imagerow))+
annotation_raster(img,xmin = 0,xmax = Inf,ymin = 0,ymax = Inf) +
geom_contour_filled(data = griddf,aes(x = x, y = (-y) , z=z)) +
coord_equal()+
theme_void()
p3<- ggplot(data = griddf,aes(x = x, y = (-y) , z=z2))+
annotation_raster(img,xmin = 0,xmax = Inf,ymin = 0,ymax = Inf) +
geom_contour(breaks = thresh) +
geom_contour_filled(alpha=thresh.alpha, breaks = c(thresh,1), fill="blue")+
coord_equal()+
theme_void()
p1
p2<- ggplot(data = ic_types,aes(x = imagecol, y = imagerow))+
annotation_raster(img,xmin = 0,xmax = Inf,ymin = 0,ymax = Inf) +
geom_contour_filled(data = griddf,aes(x = x, y = (-y) , z=z)) +
coord_equal()+
theme_void()
p2
p3
p1
p3
# Create plotly object
fig <- plot_ly(type = 'scatter',
mode='markers'
)
# Add image in the background
fig <- fig %>% add_trace(type="image", source = raster2uri(raster::as.raster(data@images$slice1@image)), hoverinfo = "skip")
fig <- fig %>%
add_trace(
type = "contour",
x = griddf$x,
y = griddf$y,
z = griddf$z2,
showlegend = T,
contours = list(
end = 1,
size = 0.1,
start = input$Plot_thresh_density
),
opacity=input$Plot_thresh_alpha_density
)
fig <- fig %>% colorbar(title = "Cell type\ndensity")
fig <- fig %>% layout(xaxis=list(showgrid = FALSE, showticklabels=FALSE),
yaxis = list(showgrid = FALSE, showticklabels=FALSE),
autosize = TRUE
)
fig
fig <- fig %>%
add_trace(
type = "contour",
x = griddf$x,
y = griddf$y,
z = griddf$z2,
showlegend = T,
contours = list(
end = 1,
size = 0.1,
start = 0.3
),
opacity=0.5
)
fig <- fig %>% colorbar(title = "Cell type\ndensity")
fig <- fig %>% layout(xaxis=list(showgrid = FALSE, showticklabels=FALSE),
yaxis = list(showgrid = FALSE, showticklabels=FALSE),
autosize = TRUE
)
fig
fig = griddf$z
fig <- fig %>%
plot_ly(
type = 'densitymapbox',
lat = griddf$x,
lon = griddf$y,
coloraxis = 'coloraxis',
radius = 10)
fig <- fig %>%
layout(
mapbox = list(
style="stamen-terrain",
center= list(lon=180)), coloraxis = list(colorscale = "Viridis"))
# Create plotly object
fig <- plot_ly(type = 'scatter',
mode='markers'
)
# Add image in the background
fig <- fig %>% add_trace(type="image", source = raster2uri(raster::as.raster(data@images$slice1@image)), hoverinfo = "skip")
fig <- fig %>% colorbar(title = "Cell type\ndensity")
fig <- fig %>% layout(xaxis=list(showgrid = FALSE, showticklabels=FALSE),
yaxis = list(showgrid = FALSE, showticklabels=FALSE),
autosize = TRUE
)
fig
#
p1<-   ggplot( data = ic_types,aes(x = imagecol, y = imagerow)) +
annotation_raster(img,xmin = 0,xmax = Inf,ymin = 0,ymax = Inf)+
geom_contour(data = griddf,aes(x = x, y = (-y) , z=z2),breaks = thresh)  +
geom_contour_filled(data = griddf,aes(x = x, y = (-y) , z=z2),alpha=thresh.alpha, breaks = c(thresh,1), fill="blue")+
coord_equal()+
theme_void()
p1
ggplotly(p1)
fig <- fig %>% ggplotly(p1)
# Add image in the background
fig <- fig %>% add_trace(type="image", source = raster2uri(raster::as.raster(data@images$slice1@image)), hoverinfo = "skip")
fig <- fig %>% colorbar(title = "Cell type\ndensity")
fig <- fig %>% layout(xaxis=list(showgrid = FALSE, showticklabels=FALSE),
yaxis = list(showgrid = FALSE, showticklabels=FALSE),
autosize = TRUE
)
fig
fig <- fig %>% ggplotly(p1)
fig
fig <- ggplotly(p1)
# Add image in the background
fig <- fig %>% add_trace(type="image", source = raster2uri(raster::as.raster(data@images$slice1@image)), hoverinfo = "skip")
fig <- fig %>% colorbar(title = "Cell type\ndensity")
fig <- fig %>% layout(xaxis=list(showgrid = FALSE, showticklabels=FALSE),
yaxis = list(showgrid = FALSE, showticklabels=FALSE),
autosize = TRUE
)
fig
l=length(type)
ic_types=values$data@reductions$ica@cell.embeddings[,type]
ic_types<-apply(ic_types,2,function(x){x=ifelse(x<=0,0,x); return(x)})
sum_IC<-apply(ic_types,2,function(x){x=x/sum(x); return(x)})
sum_IC=sqrt((rowSums(sum_IC)/max(rowSums(sum_IC))))
ic_types<-apply(ic_types,1,function(x){x/sum(x); return(x)})
ic_types<-cbind(GetTissueCoordinates(values$data),t(ic_types)) %>%  cbind(.,sum_IC)
grid=interp(ic_types$imagecol,ic_types$imagerow,ic_types$sum_IC)
l=length(type)
ic_types=values$data@reductions$ica@cell.embeddings[,type]
ic_types=data@reductions$ica@cell.embeddings[,type]
ic_types<-apply(ic_types,2,function(x){x=ifelse(x<=0,0,x); return(x)})
sum_IC<-apply(ic_types,2,function(x){x=x/sum(x); return(x)})
sum_IC=sqrt((rowSums(sum_IC)/max(rowSums(sum_IC))))
ic_types<-apply(ic_types,1,function(x){x/sum(x); return(x)})
ic_types<-cbind(GetTissueCoordinates(values$data),t(ic_types)) %>%  cbind(.,sum_IC)
ic_types<-cbind(GetTissueCoordinates(values$data),t(ic_types)) %>%  cbind(.,sum_IC)
ic_types
View(ic_types)
ic_types<-cbind(GetTissueCoordinates(values$data),t(ic_types)) %>%  cbind(.,sum_IC)
ic_types=values$data@reductions$ica@cell.embeddings[,type]
l=length(type)
ic_types=data@reductions$ica@cell.embeddings[,type]
ic_types<-apply(ic_types,2,function(x){x=ifelse(x<=0,0,x); return(x)})
sum_IC<-apply(ic_types,2,function(x){x=x/sum(x); return(x)})
sum_IC=sqrt((rowSums(sum_IC)/max(rowSums(sum_IC))))
ic_types<-apply(ic_types,1,function(x){x/sum(x); return(x)})
ic_types<-cbind(GetTissueCoordinates(data),t(ic_types)) %>%  cbind(.,sum_IC)
grid=interp(ic_types$imagecol,ic_types$imagerow,ic_types$sum_IC)
griddf <- data.frame(x = rep(grid$x, ncol(grid$z)),
y = rep(grid$y, each = nrow(grid$z)),
z = as.numeric(grid$z))
griddf$z2=ifelse(griddf$z<quantile(griddf$z,na.rm = TRUE,probs = seq(0, 1, 1/10))[2],0,griddf$z)
# Create plotly object
fig <- plot_ly(type = 'scatter',
mode='markers'
)
#
p1<-   ggplot( data = ic_types,aes(x = imagecol, y = imagerow)) +
annotation_raster(img,xmin = 0,xmax = Inf,ymin = 0,ymax = Inf)+
geom_contour(data = griddf,aes(x = x, y = (-y) , z=z2),breaks = thresh)  +
geom_contour_filled(data = griddf,aes(x = x, y = (-y) , z=z2),alpha=thresh.alpha, breaks = c(thresh,1), fill="blue")+
coord_equal()+
theme_void()
p1
fig <- ggplotly(p1)
# Add image in the background
fig <- fig %>% add_trace(type="image", source = raster2uri(raster::as.raster(data@images$slice1@image)), hoverinfo = "skip")
fig <- fig %>% colorbar(title = "Cell type\ndensity")
fig <- fig %>% layout(xaxis=list(showgrid = FALSE, showticklabels=FALSE),
yaxis = list(showgrid = FALSE, showticklabels=FALSE),
autosize = TRUE
)
fig
#
p1<-   ggplot( data = ic_types,aes(x = imagecol, y = imagerow)) +
annotation_raster(img,xmin = 0,xmax = Inf,ymin = 0,ymax = Inf)+
geom_contour(data = griddf,aes(x = x, y = y , z=z2),breaks = thresh)  +
geom_contour_filled(data = griddf,aes(x = x, y = y , z=z2),alpha=thresh.alpha, breaks = c(thresh,1), fill="blue")+
coord_equal()+
theme_void()
fig <- ggplotly(p1)
# Add image in the background
fig <- fig %>% add_trace(type="image", source = raster2uri(raster::as.raster(data@images$slice1@image)), hoverinfo = "skip")
fig <- fig %>% colorbar(title = "Cell type\ndensity")
fig <- fig %>% layout(xaxis=list(showgrid = FALSE, showticklabels=FALSE),
yaxis = list(showgrid = FALSE, showticklabels=FALSE),
autosize = TRUE
)
fig
# Create plotly object
fig <- plot_ly(type = 'scatter',
mode='markers'
)
# Add image in the background
fig <- fig %>% add_trace(type="image", source = raster2uri(raster::as.raster(data@images$slice1@image)), hoverinfo = "skip")
fig <- fig %>%
add_trace(
type = "contour",
x = griddf$x,
y = griddf$y,
z = griddf$z2,
showlegend = T,
contours = list(
end = 1,
size = 0.1,
start = input$Plot_thresh_density
),
opacity=input$Plot_thresh_alpha_density
)
fig <- fig %>% colorbar(title = "Cell type\ndensity")
# Create plotly object
fig <- plot_ly(type = 'scatter',
mode='markers'
)
# Add image in the background
fig <- fig %>% add_trace(type="image", source = raster2uri(raster::as.raster(data@images$slice1@image)), hoverinfo = "skip")
fig <- fig %>%
add_trace(
type = "contour",
x = griddf$x,
y = griddf$y,
z = griddf$z2,
showlegend = T,
contours = list(
end = 1,
size = 0.1,
start = 0.4
),
opacity=0.5
)
fig <- fig %>% colorbar(title = "Cell type\ndensity")
fig <- fig %>% layout(xaxis=list(showgrid = FALSE, showticklabels=FALSE),
yaxis = list(showgrid = FALSE, showticklabels=FALSE),
autosize = TRUE
)
fig
launchShiny()
launchShiny()
launchShiny()
launchShiny()
launchShiny()
p1<-   ggplot( data = ic_types,aes(x = imagecol, y = imagerow)) +
annotation_raster(img,xmin = 0,xmax = Inf,ymin = 0,ymax = Inf)+
geom_contour(data = griddf,aes(x = x, y = y , z=z2),breaks = input$Plot_thresh_density)  +
coord_equal()+
theme_void()
p1<-   ggplot( data = ic_types,aes(x = imagecol, y = imagerow)) +
annotation_raster(img,xmin = 0,xmax = Inf,ymin = 0,ymax = Inf)+
geom_contour(data = griddf,aes(x = x, y = y , z=z2),breaks = 0.3)  +
coord_equal()+
theme_void()
p1
ic_types
ic_types$imagecol
ic_types
griddf
launchShiny()
"./data.RDS"
p = "./data.RDS"
grep(p)
grep(p,'.RDS')
grep('.RDS',p)
grep('RDS',p)
grep('.RDS',p)
grep('ABC',p)
library(igraph)
library(CellChat)
library(tidyverse)
library(Seurat)
library(pheatmap)
#library(spatialEco)
# library(Cairo)
library(e1071)
# library(patchwork)
library(ggalluvial)
library(NMF)
# library(copykat)
library(enrichR)
library(ape)
#library(Rfast2)
#library(harmony)
#library(furrr)
library(copykat)
library(diffusionMap)
library(destiny)
library(glmnet)
#
library(png)
library(grid)
#
library(stats)
library(interp)
library(MASS)
library(scatterpie)
#bayesspace
library(SingleCellExperiment)
library(ggplot2)
library(BayesSpace)
library(Matrix)
library(geometry)
### subcluster
library(slingshot)
library(glmnet)
options(browser = "firefox")
library(corrplot)
library(phateR)
setEnrichrSite("Enrichr")
dbs <- listEnrichrDbs()
websiteLive <- TRUE
n_cores = 8
future::plan("multicore", workers = n_cores)
source('/home/c_thuilliez/Desktop/scRNAS_CT/R/Cluster_ICA.R')
source('/home/c_thuilliez/Desktop/scRNAS_CT/R/Copykat.R')
source('/home/c_thuilliez/Desktop/scRNAS_CT/R/DoHeatmapICA.R')
source('/home/c_thuilliez/Desktop/scRNAS_CT/R/ICGeneAndStats.R')
source('/home/c_thuilliez/Desktop/scRNAS_CT/R/Markers_Clusters_ICA.R')
source('/home/c_thuilliez/Desktop/scRNAS_CT/R/Minor_functions.R')
source('/home/c_thuilliez/Desktop/scRNAS_CT/R/prepare_data.R')
source('/home/c_thuilliez/Desktop/scRNAS_CT/R/RunICA.R')
source('/home/c_thuilliez/Desktop/scRNAS_CT/R/Show_IC_and_Enrich.R')
source('/home/c_thuilliez/Desktop/scRNAS_CT/R/DoHeatmapICA_S.R')
source('/home/c_thuilliez/Desktop/scRNAS_CT/R/Show_IC_and_Enrich_S.R')
source('/home/c_thuilliez/Desktop/scRNAS_CT/R/launchShiny.R')
launchShiny()
launchShiny()
launchShiny()
data = readRDS('/home/c_thuilliez/Desktop/Work/output/Spatial_Patient/MAP330/data.RDS')
launchShiny()
library(multipanelfigure)
install.packages(multipanelfigure)
install.packages('multipanelfigure')
ceiling(203.0982)
floor(203.0982)
min_x = min(c(ceiling(203.0982),floor(203.0982)))
min_x = min(c(ceiling(203.0982),floor(203.0982)))-4
min_x = min(c(ceiling(203.0982),floor(203.0982)))-4
min_y = min(c(ceiling(149.1196),floor(149.1196)))-4
min_x = min(c(ceiling(203.0982),floor(203.0982)))-4
min_y = min(c(ceiling(149.1196),floor(149.1196)))-4
max_x = min(c(ceiling(203.0982),floor(203.0982)))+4
max_y = min(c(ceiling(149.1196),floor(149.1196)))+4
library('multipanelfigure')
grid:::valid.units
grid:::valid.units()
grid:::valid.units('px')
grid:::valid.units('inches')
grid:::valid.units('cm')
grid:::valid.units('pixel')
figure <- multi_panel_figure(
width = c(min_x, max_x),
height = c(min_x, max_x),
unit = "inches")
r_logo <- system.file("/home/c_thuilliez/Desktop/Work/output/Spatial_Patient/MAP330/tissue_hires_image.png", package = "multipanelfigure")
crop.image(img, min_x, min_y, max_x, max_y)
library('imagefx')
library(imagefx)
install.packages('imagefx')
library(imagefx)
crop.image(img, min_x, min_y, max_x, max_y)
img = data@images$slice1@image
min_x = min(c(ceiling(203.0982),floor(203.0982)))-4
min_y = min(c(ceiling(149.1196),floor(149.1196)))-4
max_x = min(c(ceiling(203.0982),floor(203.0982)))+4
max_y = min(c(ceiling(149.1196),floor(149.1196)))+4
crop.image(img, min_x, min_y, max_x, max_y)
View(crop.image(img, min_x, min_y, max_x, max_y))
View(crop.image(img, min_x, min_y, max_x, max_y))$image.crop
View(crop.image(img, min_x, min_y, max_x, max_y)$image.crop)
cropped_image = crop.image(img, min_x, min_y, max_x, max_y)
img = data@images$slice1@image
min_x = min(c(ceiling(203.0982),floor(203.0982)))-4
min_y = min(c(ceiling(149.1196),floor(149.1196)))-4
max_x = min(c(ceiling(203.0982),floor(203.0982)))+4
max_y = min(c(ceiling(149.1196),floor(149.1196)))+4
cropped_image = crop.image(img, min_x, min_y, max_x, max_y)
cropped_image
cropped_image$img.crop
View(cropped_image$img.crop)
data@meta.data
data@meta.data$nFeature_SCT
launchShiny()
launchShiny()
cropped_image = crop.image(img, min_x, min_y, max_x, max_y)
View(cropped_image)
View(cropped_image[1])
cropped_image$img.crop
launchShiny()
library(imagefx)
launchShiny()
launchShiny()
launchShiny()
