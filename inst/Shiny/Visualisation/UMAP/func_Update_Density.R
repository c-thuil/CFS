##----------------------------------------------------------------------------##
## Plot the plotly scatter plot
##----------------------------------------------------------------------------##

current_plot_density <- reactive({
  if (!is.null(values$UMAP)){
    if(length(input$Plot_display_type_choice) != 1){
      name = paste(input$Plot_display_type_choice,collapse = ",")
      for (n_cell_type in 1:length(input$Plot_display_type_choice)) {
        if(n_cell_type == 1) {
          type = values$annotation_for_output[[n_cell_type]]
        } else {
          type = append(type, values$annotation_for_output[[n_cell_type]])
        }
      }
      type = unique(type)
    } else {
      name = input$Plot_display_type_choice
      type = values$annotation_for_output[[input$Plot_display_type_choice]]
    }
    l=length(type)
    
    if (l > 1){
      ic_types=values$UMAP@reductions$ica@cell.embeddings[,type]
      
      ic_types<-apply(ic_types,2,function(x){x=ifelse(x<=0,0,x); return(x)})
      sum_IC<-apply(ic_types,2,function(x){x=x/sum(x); return(x)})
      sum_IC=sqrt((rowSums(sum_IC)/max(rowSums(sum_IC))))
      ic_types<-apply(ic_types,1,function(x){x/sum(x); return(x)})
      ic_types<-cbind(values$UMAP@reductions$umap@cell.embeddings,t(ic_types)) %>%  cbind(.,sum_IC)
      grid=interp(ic_types[,'UMAP_1'],ic_types[,'UMAP_2'],ic_types[,'sum_IC'], nx = 400, ny = 400)
      griddf <- data.frame(x = rep(grid$x, ncol(grid$z)), 
                           y = rep(grid$y, each = nrow(grid$z)), 
                           z = as.numeric(grid$z))    
      griddf$z2=ifelse(griddf$z<quantile(griddf$z,na.rm = TRUE,probs = seq(0, 1, 1/10))[2],0,griddf$z)
      
      # Create plotly object
      fig <- plot_ly(type = 'scatter',
                     mode='markers'
      )
      
      # Add density
      if (input$Plot_contour_density == TRUE){
        # continuer Ã  faire des formes
        x = data@reductions$ica@cell.embeddings[,type]
        x$sum = as.vector(lapply(x,sum))
        
        fig <- fig %>% add_trace(
          type = "scatter",
          mode = "lines",
          fill = "toself",
          x = c(2,4,6,4,2),
          y = c(2,4,2,0,2),
          # x = griddf$x,
          # y = griddf$y,
          # z = griddf$z2,
          showlegend = T,
          # contours = list(
          #   end = 1,
          #   size = 0.1,
          #   start = input$Plot_thresh_density
          # ),
          opacity=1
        )

        fig <- fig %>% colorbar(title = "UMAP\ndensity")
        
        # fig <- fig %>% layout(xaxis=list(showgrid = FALSE, showticklabels=FALSE),
        #                       yaxis = list(showgrid = FALSE, showticklabels=FALSE),
        #                       autosize = TRUE,
        #                       shapes = list(
        #                         list(type = "rect",
        #                              fillcolor = "blue", line = list(color = "blue"), opacity = 0.3,
        #                              x0 = "1980-01-01", x1 = "1985-01-01", xref = "x",
        #                              y0 = 4, y1 = 12.5, yref = "y"))
        # )
        
      } else {
        
        fig <- fig %>%
          add_trace(
            type = "contour",
            x = griddf$x,
            y = griddf$y,
            z = griddf$z2,
            showlegend = T,
            contours = list(
              end = 1, 
              size = 0.1, 
              start = input$Plot_thresh_density
            ),
            opacity=1
          )
        
        fig <- fig %>% colorbar(title = "UMAP\ndensity")
      }
  
      # ADD umap
      for (i in 0:length(summary(values$UMAP@meta.data[["seurat_clusters"]]))-1){
        fig <- fig %>%
          add_trace(
            x = values$UMAP[["umap"]]@cell.embeddings[which(values$UMAP@meta.data[["seurat_clusters"]]==i),1],
            y = values$UMAP[["umap"]]@cell.embeddings[which(values$UMAP@meta.data[["seurat_clusters"]]==i),2],
            name = i,
            marker = list(
              color = palette()[i+1],
              size = 5
            ),
            showlegend = T,
            text = i,
            customdata = rownames(values$UMAP@meta.data)[which(values$UMAP@meta.data[["seurat_clusters"]]==i)],
            hovertemplate = paste0("Cell : %{customdata}<br>",
                                   "Cluster : %{text}",
                                   "<extra></extra>"),
            opacity=input$Plot_thresh_alpha_density
          )
      }
      
      fig <- fig %>% layout(xaxis=list(showgrid = FALSE, showticklabels=FALSE),
                            yaxis = list(showgrid = FALSE, showticklabels=FALSE),
                            autosize = TRUE
      )
    } else {
      ic_types=values$UMAP@reductions$ica@cell.embeddings[,type]
      # Create plotly object
      fig <- plot_ly(type = 'scatter',
                     mode='markers'
      )

      # ADD umap
      fig <- fig %>%
        add_trace(
          x = values$UMAP[["umap"]]@cell.embeddings[,1],
          y = values$UMAP[["umap"]]@cell.embeddings[,2],
          name = name,
          marker = list(
            color = ic_types,
            size = 5
          ),
          showlegend = T,
          text = ic_types,
          customdata = rownames(values$UMAP@meta.data),
          hovertemplate = paste0("Cell : %{customdata}<br>",
                                 "Level : %{text}",
                                 "<extra></extra>")
        )
      
      fig <- fig %>% layout(xaxis=list(showgrid = FALSE, showticklabels=FALSE),
                            yaxis = list(showgrid = FALSE, showticklabels=FALSE),
                            autosize = TRUE
      )
    }
    return(fig)
  } else {
    return(NULL)
  }
})